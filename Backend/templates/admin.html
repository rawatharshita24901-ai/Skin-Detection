<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Skin Disease Detection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar h1 {
            font-size: 24px;
        }

        .navbar a {
            color: white;
            text-decoration: none;
            margin-left: 20px;
            font-weight: 600;
            cursor: pointer;
        }

        .navbar a:hover {
            opacity: 0.8;
        }

        .container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: 700;
            color: #667eea;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .card h2 {
            margin-bottom: 20px;
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f5f5f5;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .chart-container {
            margin-top: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .disease-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .disease-item:last-child {
            border-bottom: none;
        }

        .disease-name {
            font-weight: 600;
            color: #333;
        }

        .disease-count {
            color: #667eea;
            font-weight: 700;
        }

        .btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>üìä Admin Dashboard</h1>
        <div>
            <a href="/">Home</a>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <div class="container">
        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Users</h3>
                <div class="number" id="totalUsers">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Predictions</h3>
                <div class="number" id="totalPredictions">-</div>
            </div>
            <div class="stat-card">
                <h3>Unique Diseases</h3>
                <div class="number" id="uniqueDiseases">-</div>
            </div>
            <div class="stat-card">
                <h3>Avg Confidence</h3>
                <div class="number" id="avgConfidence">-</div>
            </div>
        </div>

        <!-- Disease Statistics -->
        <div class="card">
            <h2>ü¶† Disease Detection Statistics</h2>
            <div id="diseaseStats" class="chart-container">
                <div class="loading">Loading...</div>
            </div>
        </div>

        <!-- Disease Report -->
        <div class="card">
            <h2>üìã Detailed Disease Report</h2>
            <table id="diseaseReportTable">
                <thead>
                    <tr>
                        <th>Disease</th>
                        <th>Total Detections</th>
                        <th>Avg Confidence</th>
                        <th>Min Confidence</th>
                        <th>Max Confidence</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="5" style="text-align: center;">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Recent Predictions -->
        <div class="card">
            <h2>‚è±Ô∏è Recent Predictions</h2>
            <table id="recentPredictionsTable">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Disease</th>
                        <th>Confidence</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="4" style="text-align: center;">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Export Section -->
        <div class="card" style="text-align: center;">
            <h2>üì• Export Data</h2>
            <button class="btn" onclick="exportData()">Download All Data (JSON)</button>
        </div>
    </div>

    <script>
        async function loadAdminData() {
            try {
                const response = await fetch('/admin');
                const data = await response.json();

                // Update stats
                document.getElementById('totalUsers').textContent = data.total_users;
                document.getElementById('totalPredictions').textContent = data.total_predictions;
                document.getElementById('uniqueDiseases').textContent = data.disease_stats.length;

                // Calculate average confidence
                let totalConfidence = 0;
                let count = 0;
                data.avg_confidence.forEach(item => {
                    totalConfidence += item.avg_confidence;
                    count++;
                });
                const avgConf = count > 0 ? (totalConfidence / count * 100).toFixed(1) : 0;
                document.getElementById('avgConfidence').textContent = avgConf + '%';

                // Display disease statistics
                const diseaseStatsHtml = data.disease_stats.map(d => `
                    <div class="disease-item">
                        <span class="disease-name">${d.disease}</span>
                        <span class="disease-count">${d.count} detections</span>
                    </div>
                `).join('');
                document.getElementById('diseaseStats').innerHTML = diseaseStatsHtml;

                // Display disease report
                const reportRows = data.disease_stats.map(d => {
                    const conf = data.avg_confidence.find(a => a.disease === d.disease);
                    return `
                        <tr>
                            <td>${d.disease}</td>
                            <td>${d.count}</td>
                            <td>${conf ? (conf.avg_confidence * 100).toFixed(2) : 'N/A'}%</td>
                            <td>-</td>
                            <td>-</td>
                        </tr>
                    `;
                }).join('');
                document.getElementById('diseaseReportTable').querySelector('tbody').innerHTML = reportRows;

                // Display recent predictions
                const recentRows = data.recent_predictions.map(p => `
                    <tr>
                        <td>${p.user}</td>
                        <td>${p.disease}</td>
                        <td>${(p.confidence * 100).toFixed(2)}%</td>
                        <td>${p.date}</td>
                    </tr>
                `).join('');
                document.getElementById('recentPredictionsTable').querySelector('tbody').innerHTML = recentRows;

            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }

        function exportData() {
            fetch('/admin/export-data')
                .then(r => r.json())
                .then(data => {
                    const dataStr = JSON.stringify(data.data, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `skin-detection-data-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
        }

        // Load data on page load
        window.addEventListener('load', loadAdminData);
    </script>
</body>
</html>
